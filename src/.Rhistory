rep("pos",length(Alpha_Div_pos$Chao))),
levels = c("before","pos")))
Chao_plot<- ggplot(Chao, aes(x = Group, y = Chao_Index)) +
geom_boxplot(aes(fill = Group)) +scale_fill_manual(labels =  c(expression(italic("A.fumigatus -")), expression(italic("A.fumigatus +"))),values=c("#56B4E9","#E69F00"))+
theme_pubr()  +
theme(plot.title = element_text(size = 25, hjust = 0.5),  text = element_text(size = 28), legend.title = element_blank() , axis.text.x=element_blank(), axis.ticks = element_blank(),
legend.key.size = unit(2, "cm"),legend.text=element_text(size=24)) +
geom_signif(test="wilcox.test", comparisons = list(c("before", "pos")), map_signif_level=function(p) sprintf("p = %.2g", p), test.args=list(paired = T), tip_length = 0,textsize = 10,y_position = 240) +
xlab(element_blank()) + ylab('Chao index') +
geom_dotplot(binaxis='y', stackdir='center', dotsize=0, binwidth = 0.02)+coord_cartesian(ylim = c(0 ,280))
#ggtitle("Comparison of Chao Index ")
g <- ggarrange(plotlist=list(Shannon_plot,Chao_plot),common.legend = TRUE)
ggsave("alpha_diversity.pdf",g, width = 8)
#### Aitchison-PCoA
set.seed(123)
SAM= meta_df
aitch_full_features <- t(metaphlan_df)
aitch_full_features[aitch_full_features == 0] <- 0.00001
dist.aitchison= coda.base::dist(aitch_full_features, method="aitchison", diag=T, upper=T)
ord.aitchison <-  cmdscale(dist.aitchison, k = 2, eig = T)
adonis.aitchison <- adonis2(dist.aitchison ~  Cohort, data = SAM, permutations = 999)
pcoa.aitchison.plotting <- as.data.frame(ord.aitchison$points)
colnames(pcoa.aitchison.plotting) <- c("axis_1", "axis_2")
pcoa.aitchison.plotting$cohort <- SAM$Cohort
pcoa.aitchison.plotting$label <- SAM$Sample
pcoa_ep1 <- round(ord.aitchison$eig[1]/(sum(ord.aitchison$eig))*100,1)
pcoa_ep2 <- round(ord.aitchison$eig[2]/(sum(ord.aitchison$eig))*100,1)
pcoa.aitchison.plotting$id <- c(1:40,1:40)
pcoa.aitchison.plotting$label <- c(1:40,1:40)
pcoa.aitchison.plot <- ggplot(pcoa.aitchison.plotting, aes(x = axis_1, y = axis_2, colour = cohort,label=label)) +
geom_point(size = 3) +
geom_line(aes(group=id),col = 'gray',linetype=2)+
stat_ellipse(type = "norm")+
scale_color_manual(labels = c(expression(italic("A.fumigatus -")), expression(italic("A.fumigatus +"))),values=c("before"="#56B4E9","pos"="#E69F00")) +
theme_pubr() +
geom_text(aes(label=label),hjust=0, vjust=0,,  size=8)+
xlab(paste("PCoA 1 (",pcoa_ep1,"%)")) +
ylab(paste("PCoA 2 (",pcoa_ep2,"%)")) +
annotate(geom = "text",label = paste("p = ",round(adonis.aitchison$`Pr(>F)`[1],3)),x=0,y=max(pcoa.aitchison.plotting$axis_2)+20,hjust=0.3,size=10,colour="black")+
ggtitle("Aitchison-PCoA")+
theme(plot.title = element_text(size = 28, hjust = 0.5),  text = element_text(size = 28),legend.key.size = unit(2, "cm"),legend.title = element_blank(),legend.text=element_text(size=28),axis.title.x = element_text(size =30),
axis.title.y = element_text(size = 30))+ylim(-60,60)+xlim(-60,60)
ggsave("beta_diversity.pdf",pcoa.aitchison.plot, width = 9,height = 9)
meta_df <- read_csv('../dat/clinical_data.csv')
## Alpha Diversity
before_df <- as.data.frame(metaphlan_df)[meta_df[meta_df$Cohort=="before",]$Sample]
library(viridis)
library(ggpubr)
library(vegan)
library(sjmisc)
library(magrittr)
library(tidyverse)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort")]
colnames(meta_df) <- c("Sample", "Cohort")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
meta_df <- meta_df %>% arrange(Cohort)
metaphlan_df <- read_csv("../dat/test.csv") %>% column_to_rownames(var="...1")
## Alpha Diversity
before_df <- as.data.frame(metaphlan_df)[meta_df[meta_df$Cohort=="before",]$Sample]
pos_df <-  as.data.frame(metaphlan_df)[meta_df[meta_df$Cohort=="pos",]$Sample]
alpha_diversities <- function(df){
list = list()
list[["Shannon"]] = vegan::diversity(df,index = "shannon")
list[["Chao"]] = apply(df, 1, fossil::chao1)
return(list)
}
Alpha_Div_before = alpha_diversities(t(before_df))
Alpha_Div_pos= alpha_diversities(t(pos_df))
Shannon = data.frame(Shannon_Index = c(Alpha_Div_before$Shannon,
Alpha_Div_pos$Shannon),
Group = factor(c(rep("before",length(Alpha_Div_before$Shannon)),
rep("pos",length(Alpha_Div_pos$Shannon))),
levels = c("before","pos")))
Shannon_plot<- ggplot(Shannon, aes(x = Group, y = Shannon_Index)) +
geom_boxplot(aes(fill = Group)) +scale_fill_manual(labels =  c(expression(italic("A.fumigatus -")), expression(italic("A.fumigatus +"))),values=c("#56B4E9","#E69F00"))+
theme_pubr()  +
theme(plot.title = element_text(size = 25, hjust = 0.5),  text = element_text(size = 28), legend.title = element_blank() , axis.text.x=element_blank(), axis.ticks = element_blank(),
legend.key.size = unit(2, "cm"),legend.text=element_text(size=24)) +
geom_signif(test="wilcox.test", comparisons = list(c("before", "pos")), map_signif_level=function(p) sprintf("p = %.2g", p), test.args=list(paired = T), tip_length = 0,textsize = 10,y_position = 4.7) +
xlab(element_blank()) + ylab('Shannon index') +
geom_dotplot(binaxis='y', stackdir='center', dotsize=0, binwidth = 0.02) +
coord_cartesian(ylim = c(0 ,5.5))
#ggtitle("Comparison of Shannon Index ")
Chao = data.frame(Chao_Index = c(Alpha_Div_before$Chao,
Alpha_Div_pos$Chao),
Group = factor(c(rep("before",length(Alpha_Div_before$Chao)),
rep("pos",length(Alpha_Div_pos$Chao))),
levels = c("before","pos")))
Chao_plot<- ggplot(Chao, aes(x = Group, y = Chao_Index)) +
geom_boxplot(aes(fill = Group)) +scale_fill_manual(labels =  c(expression(italic("A.fumigatus -")), expression(italic("A.fumigatus +"))),values=c("#56B4E9","#E69F00"))+
theme_pubr()  +
theme(plot.title = element_text(size = 25, hjust = 0.5),  text = element_text(size = 28), legend.title = element_blank() , axis.text.x=element_blank(), axis.ticks = element_blank(),
legend.key.size = unit(2, "cm"),legend.text=element_text(size=24)) +
geom_signif(test="wilcox.test", comparisons = list(c("before", "pos")), map_signif_level=function(p) sprintf("p = %.2g", p), test.args=list(paired = T), tip_length = 0,textsize = 10,y_position = 240) +
xlab(element_blank()) + ylab('Chao index') +
geom_dotplot(binaxis='y', stackdir='center', dotsize=0, binwidth = 0.02)+coord_cartesian(ylim = c(0 ,280))
#ggtitle("Comparison of Chao Index ")
g <- ggarrange(plotlist=list(Shannon_plot,Chao_plot),common.legend = TRUE)
ggsave("alpha_diversity.pdf",g, width = 8)
#### Aitchison-PCoA
set.seed(123)
SAM= meta_df
aitch_full_features <- t(metaphlan_df)
aitch_full_features[aitch_full_features == 0] <- 0.00001
dist.aitchison= coda.base::dist(aitch_full_features, method="aitchison", diag=T, upper=T)
ord.aitchison <-  cmdscale(dist.aitchison, k = 2, eig = T)
adonis.aitchison <- adonis2(dist.aitchison ~  Cohort, data = SAM, permutations = 999)
pcoa.aitchison.plotting <- as.data.frame(ord.aitchison$points)
colnames(pcoa.aitchison.plotting) <- c("axis_1", "axis_2")
pcoa.aitchison.plotting$cohort <- SAM$Cohort
pcoa.aitchison.plotting$label <- SAM$Sample
pcoa_ep1 <- round(ord.aitchison$eig[1]/(sum(ord.aitchison$eig))*100,1)
pcoa_ep2 <- round(ord.aitchison$eig[2]/(sum(ord.aitchison$eig))*100,1)
pcoa.aitchison.plotting$id <- c(1:40,1:40)
pcoa.aitchison.plotting$label <- c(1:40,1:40)
pcoa.aitchison.plot <- ggplot(pcoa.aitchison.plotting, aes(x = axis_1, y = axis_2, colour = cohort,label=label)) +
geom_point(size = 3) +
geom_line(aes(group=id),col = 'gray',linetype=2)+
stat_ellipse(type = "norm")+
scale_color_manual(labels = c(expression(italic("A.fumigatus -")), expression(italic("A.fumigatus +"))),values=c("before"="#56B4E9","pos"="#E69F00")) +
theme_pubr() +
geom_text(aes(label=label),hjust=0, vjust=0,,  size=8)+
xlab(paste("PCoA 1 (",pcoa_ep1,"%)")) +
ylab(paste("PCoA 2 (",pcoa_ep2,"%)")) +
annotate(geom = "text",label = paste("p = ",round(adonis.aitchison$`Pr(>F)`[1],3)),x=0,y=max(pcoa.aitchison.plotting$axis_2)+20,hjust=0.3,size=10,colour="black")+
ggtitle("Aitchison-PCoA")+
theme(plot.title = element_text(size = 28, hjust = 0.5),  text = element_text(size = 28),legend.key.size = unit(2, "cm"),legend.title = element_blank(),legend.text=element_text(size=28),axis.title.x = element_text(size =30),
axis.title.y = element_text(size = 30))+ylim(-60,60)+xlim(-60,60)
ggsave("beta_diversity.pdf",pcoa.aitchison.plot, width = 9,height = 9)
adonis.aitchison
library(viridis)
library(circlize)
library(ComplexHeatmap)
library(ggpubr)
library(vegan)
library(phyloseq)
library(phylosmith)
library(sjmisc)
library(magrittr)
library(tidyverse)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort")]
colnames(meta_df) <- c("Sample", "Cohort")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
meta_df <- meta_df %>% arrange(Cohort)
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
metaphlan_df
library(ggvenn)
library(viridis)
library(circlize)
library(ComplexHeatmap)
library(ggpubr)
library(vegan)
library(phyloseq)
library(phylosmith)
library(sjmisc)
library(magrittr)
library(tidyverse)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort")]
colnames(meta_df) <- c("Sample", "Cohort")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
meta_df <- meta_df %>% arrange(Cohort)
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id,Cohort)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort")]
colnames(meta_df) <- c("Sample", "Cohort")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
meta_df <- meta_df %>% arrange(Cohort)
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
View(metaphlan_df)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id,cohort)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort")]
colnames(meta_df) <- c("Sample", "Cohort")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
metaphlan_df
metaphlan_df
taxa<- data.frame("Genus" =str_split(rownames(metaphlan_df), "_", simplify = T)[,1] ,"Species" = rownames(metaphlan_df))
taxa
rownames(taxa) <- taxa$Species
taxa<- data.frame("Genus" =str_split(rownames(metaphlan_df), "_", simplify = T)[,1] ,"Species" = rownames(metaphlan_df))
rownames(taxa) <- taxa$Species
META <- sample_data(meta_df)
TAX <- tax_table(as.matrix(taxa))
OTU <- otu_table(metaphlan_df,taxa_are_rows=TRUE)
physeq <- phyloseq(OTU, TAX, META)
physeq_relative_abundance <- phyloseq(OTU, TAX, META
)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id,cohort,clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort","clinic_id")]
colnames(meta_df) <- c("Sample", "Cohort")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
taxa<- data.frame("Genus" =str_split(rownames(metaphlan_df), "_", simplify = T)[,1] ,"Species" = rownames(metaphlan_df))
rownames(taxa) <- taxa$Species
META <- sample_data(meta_df)
TAX <- tax_table(as.matrix(taxa))
OTU <- otu_table(metaphlan_df,taxa_are_rows=TRUE)
physeq_relative_abundance <- phyloseq(OTU, TAX, META)
sample_df <- meta_df %>% filter(Cohort!="neg") %>% arrange(Cohort,clinic_id)
meta_df  %>% arrange(Cohort,clinic_id)
meta_df
colnames(meta_df)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id,cohort,clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort","clinic_id")]
colnames(meta_df) <- c("Sample", "Cohort","clinic_id")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
taxa<- data.frame("Genus" =str_split(rownames(metaphlan_df), "_", simplify = T)[,1] ,"Species" = rownames(metaphlan_df))
rownames(taxa) <- taxa$Species
META <- sample_data(meta_df)
TAX <- tax_table(as.matrix(taxa))
OTU <- otu_table(metaphlan_df,taxa_are_rows=TRUE)
physeq_relative_abundance <- phyloseq(OTU, TAX, META)
otu_relative_abun_df <- otu_table(physeq_relative_abundance) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance)
top10_out <- otu_table(physeq_top10_relative_abundance) %>% data.frame
top10_out <- top10_out[order(apply(top10_out, 1, median, na.rm=T),decreasing=T),]
top10_out
otu_relative_abun_df <- otu_table(physeq_relative_abundance) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance)
top10_out <- otu_table(physeq_top10_relative_abundance) %>% data.frame
top10_out <- top10_out[order(apply(top10_out, 1, median, na.rm=T),decreasing=T),]
SAM_temp <- sample_data(physeq_top10_relative_abundance)
SAM_temp$Sample[SAM_temp$Cohort=="before"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="before"])[1]),"a")
SAM_temp$Sample[SAM_temp$Cohort=="pos"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="pos"])[1]),"b")
sample_data(physeq_top10_relative_abundance)<- SAM_temp
sample_names(physeq_top10_relative_abundance) <- sample_data(physeq_top10_relative_abundance)$Sample
otu_relative_abun_df <- otu_table(physeq_relative_abundance) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance)
top10_out <- otu_table(physeq_top10_relative_abundance) %>% data.frame
top10_out <- top10_out[order(apply(top10_out, 1, median, na.rm=T),decreasing=T),]
SAM_temp <- sample_data(physeq_top10_relative_abundance)
SAM_temp$Sample[SAM_temp$Cohort=="before"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="before"])[1]),"a")
SAM_temp$Sample[SAM_temp$Cohort=="pos"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="pos"])[1]),"b")
sample_data(physeq_top10_relative_abundance)<- SAM_temp
sample_names(physeq_top10_relative_abundance) <- sample_data(physeq_top10_relative_abundance)$Sample
heatmap_mat<- otu_table(physeq_top10_relative_abundance)%>% data.frame%>% as.matrix
heatmap_mat <- heatmap_mat[order(apply(heatmap_mat, 1, median, na.rm=T),decreasing=T),]
colnames(heatmap_mat) <- c(1:40,1:40)
rownames(heatmap_mat) <- gsub("_"," ",rownames(heatmap_mat) )
ha = HeatmapAnnotation(foo = anno_block(gp =  gpar(fill = c("#56B4E9","#E69F00")), labels = c("A.fumigatus -","A.fumigatus +"),labels_gp=gpar(fontface = "italic",fontsize = 20)))
split = rep(1:2, each = 40)
pdf(file="top10_species.pdf",width=16, height=9)
Heatmap(heatmap_mat,colorRamp2(c(0, 50, 100), c(rev(viridis(3)))),column_split = split, top_annotation = ha,
column_title = NULL,row_order=NULL, column_order = NULL,height = unit(8, "cm"),heatmap_legend_param = list(title="Abundance(%)"),column_names_gp = grid::gpar(fontsize = 14),row_names_gp = grid::gpar(fontsize = 13,fontface = "italic"))
dev.off()
out_csv <- apply(heatmap_mat,1,median) %>% as.data.frame()
colnames(out_csv) <- c("median_relative_abundance")
out_csv$median_relative_abundance <- round(out_csv$median_relative_abundance,3)
write.csv(out_csv,"top10_species_median_relatvie_abundance.csv")
#distribution
top <- function(x, n){
tail( order(x), n )
}
top10_c <- c()
for (i in colnames(otu_relative_abun_df)){
print(rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
top10_c <- c(top10_c,rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
}
summary_table <- table(top10_c)
top10_summary_table <- summary_table[top10_taxa] %>% as.data.frame()
in_all_summary_table <- rowSums(otu_relative_abun_df > 0)[top10_taxa] %>% as.data.frame()
summary_all <- cbind(in_all_summary_table,top10_summary_table)
summary_all[10:1,]
top <- function(x, n){
tail( order(x), n )
}
top10_c <- c()
for (i in colnames(otu_relative_abun_df)){
print(rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
top10_c <- c(top10_c,rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
}
summary_table <- table(top10_c)
top10_summary_table <- summary_table[top10_taxa] %>% as.data.frame()
in_all_summary_table <- rowSums(otu_relative_abun_df > 0)[top10_taxa] %>% as.data.frame()
summary_all <- cbind(in_all_summary_table,top10_summary_table)
summary_all[10:1,]
otu_relative_abun_df <- otu_table(physeq_relative_abundance_genus) %>% data.frame
physeq_relative_abundance_genus <- tax_glom(physeq_relative_abundance, taxrank="Genus")
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id,cohort,clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort","clinic_id")]
colnames(meta_df) <- c("Sample", "Cohort","clinic_id")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
taxa<- data.frame("Genus" =str_split(rownames(metaphlan_df), "_", simplify = T)[,1] ,"Species" = rownames(metaphlan_df))
rownames(taxa) <- taxa$Species
META <- sample_data(meta_df)
TAX <- tax_table(as.matrix(taxa))
OTU <- otu_table(metaphlan_df,taxa_are_rows=TRUE)
physeq_relative_abundance <- phyloseq(OTU, TAX, META)
physeq_relative_abundance_genus <- tax_glom(physeq_relative_abundance, taxrank="Genus")
otu_relative_abun_df <- otu_table(physeq_relative_abundance_genus) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance_genus)
SAM_temp <- sample_data(physeq_top10_relative_abundance)
SAM_temp$Sample[SAM_temp$Cohort=="before"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="before"])[1]),"a")
SAM_temp$Sample[SAM_temp$Cohort=="pos"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="pos"])[1]),"b")
sample_data(physeq_top10_relative_abundance)<- SAM_temp
sample_names(physeq_top10_relative_abundance) <- sample_data(physeq_top10_relative_abundance)$Sample
heatmap_mat<- otu_table(physeq_top10_relative_abundance)%>% data.frame%>% as.matrix
heatmap_mat <- heatmap_mat[order(apply(heatmap_mat, 1, median, na.rm=T),decreasing=T),]
colnames(heatmap_mat) <- c(1:40,1:40)
ha = HeatmapAnnotation(foo = anno_block(gp =  gpar(fill = c("#56B4E9","#E69F00")), labels = c("A.fumigatus -","A.fumigatus +"),labels_gp=gpar(fontface = "italic",fontsize = 20)))
split = rep(1:2, each = 40)
pdf(file="top10_genus.pdf",width=16, height=9)
Heatmap(heatmap_mat,colorRamp2(c(0, 50, 100), c(rev(viridis(3)))),column_split = split, top_annotation = ha,
column_title = NULL,row_order=NULL, column_order = NULL,height = unit(8, "cm"),heatmap_legend_param = list(title="Abundance(%)"),column_names_gp = grid::gpar(fontsize = 14),row_names_gp = grid::gpar(fontsize = 13,fontface = "italic"))
dev.off()
# distribution
top <- function(x, n){
tail( order(x), n )
}
top10_c <- c()
for (i in colnames(otu_relative_abun_df)){
print(rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
top10_c <- c(top10_c,rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
}
summary_table <- table(top10_c)
top10_summary_table <- summary_table[top10_taxa] %>% as.data.frame()
in_all_summary_table <- rowSums(otu_relative_abun_df > 0)[top10_taxa] %>% as.data.frame()
summary_all <- cbind(in_all_summary_table,top10_summary_table)
summary_all[10:1,]
SAM_temp
heatmap_mat
heatmap_mat
physeq_relative_abundance_genus
taxa_names(physeq_relative_abundance_genus)
str_split(taxa_names(physeq_relative_abundance_genus) , "_", simplify = T)[,1]
taxa_names(physeq_relative_abundance_genus) <- str_split(taxa_names(physeq_relative_abundance_genus) , "_", simplify = T)[,1]
otu_relative_abun_df <- otu_table(physeq_relative_abundance_genus) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance_genus)
SAM_temp <- sample_data(physeq_top10_relative_abundance)
SAM_temp$Sample[SAM_temp$Cohort=="before"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="before"])[1]),"a")
SAM_temp$Sample[SAM_temp$Cohort=="pos"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="pos"])[1]),"b")
sample_data(physeq_top10_relative_abundance)<- SAM_temp
sample_names(physeq_top10_relative_abundance) <- sample_data(physeq_top10_relative_abundance)$Sample
heatmap_mat<- otu_table(physeq_top10_relative_abundance)%>% data.frame%>% as.matrix
heatmap_mat <- heatmap_mat[order(apply(heatmap_mat, 1, median, na.rm=T),decreasing=T),]
colnames(heatmap_mat) <- c(1:40,1:40)
ha = HeatmapAnnotation(foo = anno_block(gp =  gpar(fill = c("#56B4E9","#E69F00")), labels = c("A.fumigatus -","A.fumigatus +"),labels_gp=gpar(fontface = "italic",fontsize = 20)))
split = rep(1:2, each = 40)
pdf(file="top10_genus.pdf",width=16, height=9)
Heatmap(heatmap_mat,colorRamp2(c(0, 50, 100), c(rev(viridis(3)))),column_split = split, top_annotation = ha,
column_title = NULL,row_order=NULL, column_order = NULL,height = unit(8, "cm"),heatmap_legend_param = list(title="Abundance(%)"),column_names_gp = grid::gpar(fontsize = 14),row_names_gp = grid::gpar(fontsize = 13,fontface = "italic"))
dev.off()
# distribution
top <- function(x, n){
tail( order(x), n )
}
top10_c <- c()
for (i in colnames(otu_relative_abun_df)){
print(rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
top10_c <- c(top10_c,rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
}
summary_table <- table(top10_c)
top10_summary_table <- summary_table[top10_taxa] %>% as.data.frame()
in_all_summary_table <- rowSums(otu_relative_abun_df > 0)[top10_taxa] %>% as.data.frame()
summary_all <- cbind(in_all_summary_table,top10_summary_table)
summary_all[10:1,]
library(ggvenn)
library(ggvenn)
library(viridis)
library(circlize)
library(ComplexHeatmap)
library(ggpubr)
library(vegan)
library(phyloseq)
library(phylosmith)
library(sjmisc)
library(magrittr)
library(tidyverse)
meta_df <- read_csv('../dat/clinical_data.csv')
meta_df <- meta_df%>%arrange(clinic_id,cohort,clinic_id)
meta_df <- as.data.frame(meta_df)
meta_df <-  meta_df[c("Ifd.Nummer", "cohort","clinic_id")]
colnames(meta_df) <- c("Sample", "Cohort","clinic_id")
meta_df$Cohort<- factor(meta_df$Cohort, levels = c("before", "pos"))
meta_df$Cohort <- as.factor(meta_df$Cohort)
meta_df$Sample <- paste0("D",meta_df$Sample)
rownames(meta_df) <-meta_df$Sample
metaphlan_df <- read_csv("../dat/otu.csv") %>% column_to_rownames(var="...1")
taxa<- data.frame("Genus" =str_split(rownames(metaphlan_df), "_", simplify = T)[,1] ,"Species" = rownames(metaphlan_df))
rownames(taxa) <- taxa$Species
META <- sample_data(meta_df)
TAX <- tax_table(as.matrix(taxa))
OTU <- otu_table(metaphlan_df,taxa_are_rows=TRUE)
physeq_relative_abundance <- phyloseq(OTU, TAX, META)
physeq_relative_abundance_genus <- tax_glom(physeq_relative_abundance, taxrank="Genus")
taxa_names(physeq_relative_abundance_genus) <- str_split(taxa_names(physeq_relative_abundance_genus) , "_", simplify = T)[,1]
# Top 10 species
otu_relative_abun_df <- otu_table(physeq_relative_abundance) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance)
top10_out <- otu_table(physeq_top10_relative_abundance) %>% data.frame
top10_out <- top10_out[order(apply(top10_out, 1, median, na.rm=T),decreasing=T),]
SAM_temp <- sample_data(physeq_top10_relative_abundance)
SAM_temp$Sample[SAM_temp$Cohort=="before"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="before"])[1]),"a")
SAM_temp$Sample[SAM_temp$Cohort=="pos"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="pos"])[1]),"b")
sample_data(physeq_top10_relative_abundance)<- SAM_temp
sample_names(physeq_top10_relative_abundance) <- sample_data(physeq_top10_relative_abundance)$Sample
heatmap_mat<- otu_table(physeq_top10_relative_abundance)%>% data.frame%>% as.matrix
heatmap_mat <- heatmap_mat[order(apply(heatmap_mat, 1, median, na.rm=T),decreasing=T),]
colnames(heatmap_mat) <- c(1:40,1:40)
rownames(heatmap_mat) <- gsub("_"," ",rownames(heatmap_mat) )
ha = HeatmapAnnotation(foo = anno_block(gp =  gpar(fill = c("#56B4E9","#E69F00")), labels = c("A.fumigatus -","A.fumigatus +"),labels_gp=gpar(fontface = "italic",fontsize = 20)))
split = rep(1:2, each = 40)
pdf(file="top10_species.pdf",width=16, height=9)
Heatmap(heatmap_mat,colorRamp2(c(0, 50, 100), c(rev(viridis(3)))),column_split = split, top_annotation = ha,
column_title = NULL,row_order=NULL, column_order = NULL,height = unit(8, "cm"),heatmap_legend_param = list(title="Abundance(%)"),column_names_gp = grid::gpar(fontsize = 14),row_names_gp = grid::gpar(fontsize = 13,fontface = "italic"))
dev.off()
# distribution of top 10 species
top <- function(x, n){
tail( order(x), n )
}
top10_c <- c()
for (i in colnames(otu_relative_abun_df)){
print(rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
top10_c <- c(top10_c,rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
}
summary_table <- table(top10_c)
top10_summary_table <- summary_table[top10_taxa] %>% as.data.frame()
in_all_summary_table <- rowSums(otu_relative_abun_df > 0)[top10_taxa] %>% as.data.frame()
summary_all <- cbind(in_all_summary_table,top10_summary_table)
summary_all[10:1,]
# Top 10 genus
otu_relative_abun_df <- otu_table(physeq_relative_abundance_genus) %>% data.frame
median_otu <- apply(otu_relative_abun_df, 1, median, na.rm=T)
top10_taxa <-names(median_otu)[tail( order(median_otu), 10)]
physeq_top10_relative_abundance=prune_taxa(top10_taxa, physeq_relative_abundance_genus)
SAM_temp <- sample_data(physeq_top10_relative_abundance)
SAM_temp$Sample[SAM_temp$Cohort=="before"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="before"])[1]),"a")
SAM_temp$Sample[SAM_temp$Cohort=="pos"] <- paste0("D",seq(1:dim(SAM_temp[SAM_temp$Cohort=="pos"])[1]),"b")
sample_data(physeq_top10_relative_abundance)<- SAM_temp
sample_names(physeq_top10_relative_abundance) <- sample_data(physeq_top10_relative_abundance)$Sample
heatmap_mat<- otu_table(physeq_top10_relative_abundance)%>% data.frame%>% as.matrix
heatmap_mat <- heatmap_mat[order(apply(heatmap_mat, 1, median, na.rm=T),decreasing=T),]
colnames(heatmap_mat) <- c(1:40,1:40)
ha = HeatmapAnnotation(foo = anno_block(gp =  gpar(fill = c("#56B4E9","#E69F00")), labels = c("A.fumigatus -","A.fumigatus +"),labels_gp=gpar(fontface = "italic",fontsize = 20)))
split = rep(1:2, each = 40)
pdf(file="top10_genus.pdf",width=16, height=9)
Heatmap(heatmap_mat,colorRamp2(c(0, 50, 100), c(rev(viridis(3)))),column_split = split, top_annotation = ha,
column_title = NULL,row_order=NULL, column_order = NULL,height = unit(8, "cm"),heatmap_legend_param = list(title="Abundance(%)"),column_names_gp = grid::gpar(fontsize = 14),row_names_gp = grid::gpar(fontsize = 13,fontface = "italic"))
dev.off()
# distribution of top 10 genus
top <- function(x, n){
tail( order(x), n )
}
top10_c <- c()
for (i in colnames(otu_relative_abun_df)){
print(rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
top10_c <- c(top10_c,rownames(otu_relative_abun_df)[top(otu_relative_abun_df[i],10)])
}
summary_table <- table(top10_c)
top10_summary_table <- summary_table[top10_taxa] %>% as.data.frame()
in_all_summary_table <- rowSums(otu_relative_abun_df > 0)[top10_taxa] %>% as.data.frame()
summary_all <- cbind(in_all_summary_table,top10_summary_table)
summary_all[10:1,]
